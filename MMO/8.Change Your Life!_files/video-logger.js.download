//START ACTIVTY FEED TRACKING CODE (still need the iContactID set on the success.php)//
var players = {};
var previous_stat_id = {};
var previous_page_stat_id = null;
var videoStarted = false;

var pageStart = Date.now();
var pageDuration = 0;
var startRecording = (iContactID) ? true : false;
var recorded = [];

$(document).ready(function() {
	recordPageTime();
});

function initPlayers(player) {
	//this is the only way I could get videos to track at least semi consistently on this page
	setTimeout(function() {
		bind(player);
	}, 5000);
}

function bind(player) {
	jwplayer(player).on('time', recordVideoTime);
}

function recordVideoTime(event) {
	if (players[this.id] == undefined) {
		players[this.id] = {
			time: 0
		}
	}

	if (event.position > (+players[this.id]['time'] + 5)) {
		players[this.id]['time'] = event.position;
		var id = this.id;
		if (typeof(iContactID) != 'undefined' && iContactID > 0) {
			postTime(id, players[id]['time'], function(data) {
				previous_stat_id[id] = data;
			});
		}
	}
}

function postTime(id, time, callback) {
	jQuery.ajax({
		url: '/plugins/firepixel.php',
		data: {
			iContactID: iContactID,
			record: '1',
			action: 'Video',
			cType: 'Video Duration',
			mVal: time,
			mExtra: id,
			iContactStatID: previous_stat_id[id]
		},
		success: callback
	});
}

function recordVideoAlreadyWatched() {
	//this function allows us to record contact stats for videos watched before the prospect opted in
	for (var i in players)(function(i) {
		postTime(i, players[i]['time'], function(data) {
			previous_stat_id[i] = data;
			recorded.push(i);
			allCaughtUp();
		});
	})(i);
}

function allCaughtUp() {
	//we need to make sure the video time that was recorded before the prospect opted in are posted before
	//we record any further video time, if we do not do this we will make duplicate activity feed items
	//for the same video
	var done = true;
	for (var i in players) {
		if (recorded.indexOf(i) === -1) {
			done = false;
		}
	}
	if (done) {
		startRecording = true;
	}
}

function recordPageTime() {
	//if the contact ID isn't defined, don't bother trying.
	if (typeof(iContactID) != 'undefined' & iContactID > 0) {

		if (!pageDuration) {
			pageDuration = Math.ceil((Date.now() - pageStart) / 1000);
		}

		var data = {
			iContactID: iContactID,
			track: '1',
			action: previous_page_stat_id == null ? 'PageStart' : 'Page',
			iContactStatID: previous_page_stat_id,
			cType: 'website duration',
			mExtra: cPageName,
			manualDuration: pageDuration
		}

		jQuery.ajax({
			url: '/plugins/firepixel.php',
			data: data
		}).done(function(data) {
			previous_page_stat_id = data ? data : previous_page_stat_id;
			//recorded, go ahead and record again in 5 seconds.
			setTimeout(recordPageTime, 5000);
			pageDuration += 5;
		});
	}
}