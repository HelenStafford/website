var RegPath = RegPath || {};

extend(RegPath, {
    Functions: {
        randomNumberInRange: function (min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        },
        weightCompare: function(a, b) {
            if (parseInt(a["weight_max"]) < parseInt(b["weight_max"]))
                return -1;
            if (parseInt(a["weight_max"]) > parseInt(b["weight_max"]))
                return 1;
            return 0;
        },
        weightedPopOverUrl: function (popOverUrls) {
            var randomWeight = this.randomNumberInRange(0, 100);
            popOverUrls = popOverUrls.sort(this.weightCompare);
            for(var i = 0;i<popOverUrls.length;i++)
            {
                if (randomWeight <= popOverUrls[i]["weight_max"])
                    return popOverUrls[i]["popover_url"];
            }
        },
        delayedCheckHeightForFold: function () {
            console.log('.midpath-header: ' + $('.midpath-header').height() + '\midpath-offer: ' + $('.midpath-offer').height() + '\nwindow: ' + $(window).height());
            if ($('.midpath-header').height() + $('.midpath-offer').height() > $(window).height()) {
                $('.footer').removeClass('footer-fold');
            }
        },
        checkHeightForFold: function () {
            setTimeout(this.delayedCheckHeightForFold, 4000);
        },
        padWithZeros : function (num, size) {
            var s = "000000000" + num;
            return s.substr(s.length-size);
        },
        buildDOBDropdown: function (dobFull, dobYear, dobMonth, dobDay) {
            var currentYear = new Date().getFullYear();
            var startYear = currentYear - 18;
            var endYear = startYear - 82;

            // Set up first Year option
            $('#ddl_dob_year').append($('<option>',
                    {
                        value: "",
                        text: "Birth"
                    })
                );

            for (var i = startYear; i > endYear; i--) {
                $('#ddl_dob_year').append($('<option>',
                    {
                        value: i,
                        text: i
                    })
                );
            }

            if (dobFull != '') { // individual dob values are preset to current date in the back-end, so we check if full dob is set before we preselect
                if (dobYear)
                    $("#ddl_dob_year option[value='" + dobYear + "']").prop('selected', 'selected');
                if (dobMonth)
                    $("#ddl_dob_month option[value='" + this.padWithZeros(dobMonth, 2) + "']").prop('selected', 'selected');
                if (dobDay)
                    $("#ddl_dob_day option[value='" + this.padWithZeros(dobDay, 2) + "']").prop('selected', 'selected');
            }
        },
         buildStateDropdown: function (state) {
                    var state_list = {
                            "": "Select state",
                            "AL": "Alabama",
                            "AK": "Alaska",
                            "AZ": "Arizona",
                            "AR": "Arkansas",
                            "CA": "California",
                            "CO": "Colorado",
                            "CT": "Connecticut",
                            "DE": "Delaware",
                            "DC": "District Of Columbia",
                            "FL": "Florida",
                            "GA": "Georgia",
                            "HI": "Hawaii",
                            "ID": "Idaho",
                            "IL": "Illinois",
                            "IN": "Indiana",
                            "IA": "Iowa",
                            "KS": "Kansas",
                            "KY": "Kentucky",
                            "LA": "Louisiana",
                            "ME": "Maine",
                            "MD": "Maryland",
                            "MA": "Massachusetts",
                            "MI": "Michigan",
                            "MN": "Minnesota",
                            "MS": "Mississippi",
                            "MO": "Missouri",
                            "MT": "Montana",
                            "NE": "Nebraska",
                            "NV": "Nevada",
                            "NH": "New Hampshire",
                            "NJ": "New Jersey",
                            "NM": "New Mexico",
                            "NY": "New York",
                            "NC": "North Carolina",
                            "ND": "North Dakota",
                            "OH": "Ohio",
                            "OK": "Oklahoma",
                            "OR": "Oregon",
                            "PA": "Pennsylvania",
                            "RI": "Rhode Island",
                            "SC": "South Carolina",
                            "SD": "South Dakota",
                            "TN": "Tennessee",
                            "TX": "Texas",
                            "UT": "Utah",
                            "VT": "Vermont",
                            "VA": "Virginia",
                            "WA": "Washington",
                            "WV": "West Virginia",
                            "WI": "Wisconsin",
                            "WY": "Wyoming",
                    };

                    $.each( state_list, function( key, value ) {
                        if(state == key || key == "")
                        {
                            $('#txt_state').append($('<option>',
                                {
                                    value: key,
                                    text: value,
                                    selected: 'selected'
                                })
                            );
                        }
                        else
                        {
                             $('#txt_state').append($('<option>',
                                {
                                    value: key,
                                    text: value
                                })
                            );
                        }

                    });

        },
        buildGradYearDropdown: function () {
            var startYear = new Date().getFullYear();
            var endYear = startYear - 101;

            for (var i = startYear; i > endYear; i--) {
                $('#graduation_year').append($('<option>',
                    {
                        value: i,
                        text: i
                    })
                );
            }
        },
        lookupZip : function(zipCode, accessToken)
        {
            $.ajax({
            url: "/api/zip-lookup",
            data: { zip: zipCode, access_token: accessToken },
            }).done(function(responseJson){
                if(!responseJson.success){
                    console.log("error: " + responseJson.message); 
                }
                if ($('#zip_lookup_done').length > 0) {
                    $('#zip_lookup_done').val('true').change();
                }
                console.log('pass lookup');
            });
        },
        dobPart : function(dobValue, dobPart) {
            var dob = moment(dobValue);
            if(dob != null) // null returned if moment can't parse it
            {
                switch(dobPart)
                {
                    case "day":
                        return dob.format("DD");
                    case "dayAbbr":
                        return dob.format("ddd");
                    case "dayFull":
                        return dob.format("dddd");
                    case "month":
                        return dob.format("MM");
                    case "monthAbbr":
                        return dob.format("MMM");
                    case "monthFull":
                        return dob.format("MMMM");
                    case "yearAbbr":
                        return dob.format("YY");
                    case "year":
                    case "yearFull":
                        return dob.format("YYYY");
                    default: // return full DOB if dobpart is not recognized/specified
                        return dob.format("YYYY-MM-DD");
                }
            }
            else
                return "";
        },
        setAnswer: function (answerValue) {
            if ($('#answer_value').length > 0)
                $('#answer_value').val(answerValue);
        },
        getAge: function (dobValue) {
            if (dobValue != '')
                return moment().diff(dobValue, 'years');
            else
                return 17; // default age to 17 so criteria doesn't wrongly get triggered
        },
        prepFormFieldError: function () {
            $('input').on('blur', function(){
                $(this).addClass('onX');
                $(this).next('div').addClass('onX');
             });
             $('button').on("click",function() {
                $('input').addClass('onX');
                $('input').next('div').addClass('onX');
              });
        },
        buildIntDropdown: function (dropDownId, min, max) {
            $('#' + dropDownId).append($('<option>',
                    {
                        value: "",
                        text: ""
                    })
                );

            for (var i = min; i <= max; i++) {
                $('#' + dropDownId).append($('<option>',
                    {
                        value: i,
                        text: i
                    })
                );
            }
        },
        validateFields: function(arrayOfFieldsID,submitFormOnSuccess,popUpURL,zipLookupAccessToken)
        {
                var NameFieldRegex = /^[a-zA-Z.\\'\\-\\s]+$/;
                 var stateFieldRegex = /^[^\d]+$/;
                var ZipFieldRegex = /^\d{5}(?:[-]\d{4})?$/;
                var PhoneFieldRegex = /^\d{10}$/;
                var isInputValid = true;
                var isSlideValid = true;
                
                  for (i = 0; i < arrayOfFieldsID.length; i++) {
                    switch (arrayOfFieldsID[i]) {
                        case '#txt_first_name': //First Name
                        isInputValid = NameFieldRegex.test($(arrayOfFieldsID[i]).val());
                        if(isInputValid == false){isSlideValid = false}
                            break;
                        case '#txt_state': //First Name
                        isInputValid = stateFieldRegex.test($(arrayOfFieldsID[i]).val());
                        if(isInputValid == false){isSlideValid = false;$("#txt_state").prop('required',true);}
                            break;
                        case '#txt_last_name': //Last Name
                         isInputValid = NameFieldRegex.test($(arrayOfFieldsID[i]).val());
                          if(isInputValid == false){isSlideValid = false}
                            break;
                        case '#txt_zip': // Zip
                        isInputValid = ZipFieldRegex.test($(arrayOfFieldsID[i]).val());
                          if(isInputValid == false){isSlideValid = false}else{RegPath.Functions.lookupZip($('#txt_zip').val(), zipLookupAccessToken);}
                            break;
                        case '#txt_address': //Address
                            if ($(arrayOfFieldsID[i]).val().trim() == "") {
                                isSlideValid = false;
                            }
                            break;
                        case '#txt_phone': // phone
                            $('#txt_phone').removeAttr("pattern");
                            $('#txt_phone').unmask();
                            isInputValid = PhoneFieldRegex.test($(arrayOfFieldsID[i]).val());
                            if (isInputValid == false) {
                              isSlideValid = false;
                            }
                            break;
                        case '#hdn_dob': //dob 
                        
                                if ($('#ddl_dob_month').length && $('#ddl_dob_day').length && $('#ddl_dob_year').length)
                                {
                                    $('#hdn_dob').val($('#ddl_dob_month').val() + "/" + $('#ddl_dob_day').val() + '/' + $('#ddl_dob_year').val());
                                }
                                var age = RegPath.Functions.getAge($('#hdn_dob').val());
                               if(age >= 18)
                               { 
                                    if($('#hdn_dob').val().length == 10) // dob should always be mm/dd/yyyy format
                                    {
                                        var dateOfBirth = moment($('#hdn_dob').val(), 'MM/DD/YYYY');
                                        isInputValid = (dateOfBirth != null && dateOfBirth.isValid());
                                        if(isInputValid == false){
                                          isSlideValid = false;
                                        } 
                                    }
                                    else
                                    {
                                        isSlideValid = false;
                                    }
                                }
                                else
                                {
                                    alert('Must be over 18 years old');
                                    isSlideValid = false;

                                }
                            break;

                    
                    }//end switch
                }//end for
                if(isSlideValid == false){
                   $('#txt_phone').prop("pattern",  "^(\\+\\d{1,2}\\s)?\\(?\\d{3}\\)?[\\s.-]\\d{3}[\\s.-]\\d{4}$");
                   $('#hdn_dob').mask('00/00/0000');
                   $('#txt_phone').mask('(000) 000-0000');
                }
                else
                {
                  if(submitFormOnSuccess == true)
                  {
                    $('.submitForm').prop('disabled', true);

                    if(popUpURL != "" && popUpURL != "undefined")
                    {
                      window.open(popUpURL, '_blank');
                    }
                        var email = $('#remotePenCheckEmail').val();
                        if(email == "undefined" || email == null){email = "";}
                        if(email.indexOf("@gmail") == -1)
                        {
                            if (RegPath.Functions.getAge($('#hdn_dob').val()) >= 40) 
                            {
                               $('#remotePenCriteriaPassed').val('true');
                            }
                        }
                    //if zip exist make sure to give time for lookup is done else submit form
                    if($('#txt_zip').val())
                    {
                        if($('#zip_lookup_done').val() == "true")
                        {
                            $('form').submit();
                        }
                        else
                        {
                            setTimeout(function(){ $('form').submit(); }, 1500);
                        }
                    }
                    else
                    {
                         $('form').submit();
                    }
                    

                    
                     
                  }
                 
                }
                 return isSlideValid;
    
        },
        buildPartnerPopupLayer: function (layerClassName, moreInfoClassName) {
            if (layerClassName && moreInfoClassName) {
                var divClassName = (layerClassName ? layerClassName : "div.partner-popup");
                var moreInfoLinkClassName = (moreInfoClassName ? moreInfoClassName : "a.more_info");
                //init pop-ups
                $(divClassName).attr("data-close", false);

                //mark pop-up for closing if clicked on
                //close is initiated by document.mouseup, 
                //marker will stop opener from re-opening it
                $(divClassName).click(function () {
                    $(this).attr("data-close", true);
                });

                //hide all pop-ups
                $(document).mouseup(function () {
                    $(divClassName).hide();

                });

                //click on pop-up opener
                //pop-up is expected to be a child of opener
                $(moreInfoLinkClassName).click(function () {
                    var $title = $(divClassName);
                    //open if not marked for closing
                    if ($title.attr("data-close") === "false") {
                        $title.show();
                    }
                    //reset popup         
                    $title.attr("data-close", false);
                });

                //show on rollover if mouse is used
                $(moreInfoLinkClassName).mouseenter(function () {
                    var $title = $(divClassName);
                    $title.show();
                });

                //hide on roll-out
                $(moreInfoLinkClassName).mouseleave(function () {
                    var $title = $(divClassName);
                    $title.hide();
                });
            }
            else {
                console.debug("Missing layer name and/or more info layer name");
            }
        }
    }
});
