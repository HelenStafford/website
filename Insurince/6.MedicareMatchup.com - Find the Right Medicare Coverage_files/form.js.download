/**
 * Created by Atif on 8th july 2015.
 */

jQuery(function($){

    // Detect facebook app browser
    function isFacebookApp() {
        var ua = navigator.userAgent || navigator.vendor || window.opera;
        return (ua.indexOf("FBAN") > -1) || (ua.indexOf("FBAV") > -1);
    }

    // Submit the form by hitting Enter on keyboard
    $("#form-step-one-top, #form-step-one-bottom").keydown(function(event){
        if(event.keyCode == 13) {
            event.preventDefault();
            step = 1;
            if( validate('#' + $(this).attr('id')) ){ //alert(0);
                // submit_step1_to_newWindow('#' + $(this).attr('id'));
                $("#form-step-one-top,#form-step-one-bottom").attr("target","");
                $(this).submit();
            }
            return false;
        }
    });

    // Submit for form pressing clicking the go button
    $(".goBtn_step1").click( function () {
        //alert(0);
        step = 1;
       if( validate('#form-step-one-' + $(this).attr('id')) ){ //alert(0);

           // if(isFacebookApp()){
           //     // submit form in the same tab
           //     // alert(1);
           //     // $(".logo-link").html('facebook');
           //     $("#form-step-one-top,#form-step-one-bottom").attr("target","");
           //     $('#form-step-one-' + $(this).attr('id')).submit();
           // }else{
           //     // alert(0);
           //     submit_step1_to_newWindow('#form-step-one-' + $(this).attr('id'));
           // }

           $("#form-step-one-top,#form-step-one-bottom").attr("target","");
           $('#form-step-one-' + $(this).attr('id')).submit();
       }
    });

    // Submit step1 to new window and
    // Redirect to leave-behind page
    function submit_step1_to_newWindow(id){
        // Fire the click event and open a new tab without losing focus to the main form
        var evt = document.createEvent("MouseEvents");

        if(id=='#form-step-one-top') {
            var newTab = document.getElementById("submit_1st_step");
        }else {
            var newTab = document.getElementById("submit_1st_step_bottom");
        }


        if (navigator.userAgent.match(/(iPod|iPhone|iPad)/) && navigator.userAgent.match(/FBAV/i)) {
            //iOS Facebook App Browser detected
            evt.initMouseEvent("click", true, true, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
            newTab.dispatchEvent(evt);
        }else{
            evt.initMouseEvent("click", true, true, window, 0, 0, 0, 0, 0, true, false, false, false, 0, null);
            newTab.dispatchEvent(evt);
        }

        setTimeout(function () {
            location.href = siteUrl+ '/results/';
        },400);
    }



    function validate(form){ //alert(0);
        var zipRegex,
            gender,
            age,
            zipcode;

        zipRegex = /(^\d{5}$)|(^\d{5}-\d{4}$)/;

        var family = {};

        // Step 1
        if( step == 1){ //alert('5555');

            counter = document.querySelectorAll(form + " input[name='member[]']");
            console.log(counter.length);
            console.log(form);
            for(x=0;x<counter.length;x++){ //alert('for loop');

                family[x] = {}; console.log(x);

                zipcode = get_zipcode(form, x); console.log(zipcode);

                // ZipCode Validation
                if( zipcode ){
                    if (!zipRegex.test(zipcode) ) {
                        console.log('Please enter valid zipcode');
                        $(form + ' .zipcode').addClass('error');
                        $(form + ' .errorP').addClass('show-step0');
                        return false;
                    }else{
                        family[x]['ZipCode'] = zipcode;
                        $(form + ' .zipcode').removeClass('error');
                        $(form + ' .errorP').removeClass('show-step0');

                        console.log('Zip is '+zipcode);
                    }
                }else{
                    console.log('Please enter zipcode');
                    $(form + ' .zipcode').addClass('error');
                    $(form + ' .errorP').addClass('show-step0');
                    return false;
                }
            }
            for(x=0;x<counter.length;x++){
                console.log(family[x]);
            }

            $('.error-step1').css('display','none');
            step = '1a';
            return true;
        }
    }

    function get_zipcode(form, x) {
        return $(document).find(form + " [name='zipcode[" + x + "]']").val();
    }

    function isZipValid( zip_code ) {

        var validation_result = false;

        return jQuery.ajax({

            url: themeUrl + "/library/post-zip.php?zip=" + zip_code,
            async: false,
            success: function(json){
            }
        }).responseText;
    }

});
