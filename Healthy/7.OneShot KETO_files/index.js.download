$(document).ready(function () {
  window.offer.getState(function (data) {

    var user = data.profile.user;
    var shipping = data.profile.shipping;
    var selectors = window.offer.getSelectors();

    if (user) {
      $(selectors.shippingForm).find(selectors.firstName).val(user.firstName);
      $(selectors.shippingForm).find(selectors.lastName).val(user.lastName);
      $(selectors.shippingForm).find(selectors.phone).val(user.phone);
      $(selectors.shippingForm).find(selectors.email).val(user.email);
    }

    if (shipping) {
      $(selectors.shippingForm).find(selectors.address).val(shipping.address);
      if (shipping.country.length)
        $(selectors.shippingForm).find(selectors.country).val(shipping.country);
      $(selectors.shippingForm).find(selectors.state).val(shipping.state);
      $(selectors.shippingForm).find(selectors.city).val(shipping.city);
      $(selectors.shippingForm).find(selectors.zipCode).val(shipping.zipCode);
    }

    $(selectors.shippingForm).validate({
      submitHandler: function () {
        $(selectors.loader).show();

        var firstName = $(selectors.shippingForm).find(selectors.firstName).val();
        var lastName = $(selectors.shippingForm).find(selectors.lastName).val();
        var phone = $(selectors.shippingForm).find(selectors.phone).val();
        var email = $(selectors.shippingForm).find(selectors.email).val();
        var address = $(selectors.shippingForm).find(selectors.address).val();
        var country = $(selectors.shippingForm).find(selectors.country).val();
        var state = $(selectors.shippingForm).find(selectors.state).val();
        var city = $(selectors.shippingForm).find(selectors.city).val();
        var zipCode = $(selectors.shippingForm).find(selectors.zipCode).val();

        var formData = {
          "user.firstName": firstName,
          "user.lastName": lastName,
          "user.email": email,
          "user.phone": phone.replace(/\D/g, ""),
          "shippingAddress.address": address,
          "shippingAddress.country": country,
          "shippingAddress.city": city,
          "shippingAddress.state": state,
          "shippingAddress.zipCode": zipCode,
          "billingAddress.FirstName": firstName,
          "billingAddress.LastName": lastName,
          "billingAddress.address": address,
          "billingAddress.country": country,
          "billingAddress.city": city,
          "billingAddress.state": state,
          "billingAddress.zipCode": zipCode,
          sameBillingAddress: true,
          partial: true,
        };

        window.offer.sendOrder(formData, function (res) {
          if (res.success) {
            window.dataLayer.push({
              event: "SendingShippingForm",
              typeForm: "fullFormDesktop",
            });
            window.location.pathname = window.offer.getOrderPage();
          } else {
            $(selectors.loader).hide();
          }
        })

        return false;
      },
      errorPlacement: function (error, element) {
        if ($(element).hasClass("error")) {
          $(element)
            .closest('div[class^="form-holder"]')
            .addClass("has-error")
            .removeClass("accept");
          $(element).addClass("error");
        } else {
          $(element)
            .closest('div[class^="form-holder"]')
            .removeClass("has-error")
            .addClass("accept");
          $(element).removeClass("error");
        }
      },
      rules: {
        firstName: window.offer.getValidationRules("firstName"),
        lastName: window.offer.getValidationRules("lastName"),
        country: window.offer.getValidationRules("country"),
        state:  window.offer.getValidationRules("state"),
        zipCode: window.offer.getValidationRules("zipCode"),
        phone: window.offer.getValidationRules("phone"),
        email: window.offer.getValidationRules("email")
      },
    });
  });
});