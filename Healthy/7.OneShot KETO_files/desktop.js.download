window.dataLayer = window.dataLayer || [];

var selectors = {
  shippingForm: '#shipping',
  firstName: 'input[name="firstName"]',
  lastName: 'input[name="lastName"]',
  phone: 'input[name="phone"]',
  email: 'input[name="email"]',
  address: 'input[name="address"]',
  country: '#id_country',
  state: '#id_state',
  city: 'input[name="city"]',
  zipCode: 'input[name="zipCode"]',
  loader: '.popup-loading-wrapper',
  checkoutForm: '#checkout',
  billingForm: '.billing-form',
  cardNumber: 'input[name="cardNumber"]',
  cardExpMonth: '#cardExpMonth',
  cardExpYear: '#cardExpYear',
  cvv: 'input[name="cvv"]',
  paymentAsShipping: '#payment_as_shipping',
  formError: "#formError"
}

var rules = {
  expMonth: {
    required: true,
  },
  expYear: {
    required: true,
    CCExp: true,
  },
  cardNumber: {
    required: true,
    creditcard: true,
  },
  cvv: {
    required: true,
    digits: true,
    minlength: 3,
    maxlength: 4,
  },
  country: "required",
  state: "required",
  firstName: "required",
  lastName: "required",
  country: "required",
  state: "required",
  zipCode: {
    minlength: 5,
    maxlength: 5,
  },
  phone: {
    required: true,
    minlength: 10,
    maxlength: 20,
  },
  email: {
    required: true,
    email: true,
  },
}

function urlParam(name) {
  var results = new RegExp("[?&]" + name + "=([^&#]*)").exec(
    window.location.href
  );
  if (results == null) {
    return null;
  } else {
    return results[1] || 0;
  }
}

function getCurrentPath() {
  var arr = window.location.pathname.split("/");
  var page = arr.slice(0, -1);
  var name = page.join("/");

  return name;
}

function getCurrentPageName() {
  var arr = window.location.pathname.split("/");
  var page = arr[arr.length - 1];
  var name = page.split(".");

  return name[0];
}

function getPage(name) {
  var path = getCurrentPath();

  switch (name) {
    case 'confirmation':
      return path + "/confirmation.html";
    case 'order':
      return path + "/order.html";
    case 'declined':
      return path + "/declined.html";
  }
}

window.offer = {
  data: null,
  isStateLoaded: false,
  isLoading: false,
  country: null,
  usingBilling: false,
  rules: rules,

  loadState: function (cb) {
    var that = this;
    var url = "/ajax/state";
    var uid = urlParam("uid");

    if (uid) {
      url += "?uid=" + uid;
    }

    that.isLoading = true;

    $.ajaxSetup({ cache: false });
    $.get(url, function (res) {
      that.data = res.data;
      that.isStateLoaded = true;
      that.isLoading = false;
      that.country = res.data.geo.code || "US";

      var segment = res.data.segment;
      var state = res.data.state;
      var shipping = res.data.profile.shipping;

      window.dataLayer.push({
        segmentAff: segment.aff,
        segmentNet: segment.net,
        segmentSub: segment.sub,
        segmentPage: segment.page,
      });

      var r = urlParam("r");
      var isDirect = r === "direct";
      var page = getCurrentPageName();

      if (isDirect && state === "partial" && shipping.address.length && page === 'index') {
        window.location.pathname = getPage('order');
      } else if (state === "purchase" && page !== 'confirmation') {
        window.location.pathname = getPage('confirmation');
      } else if (state === "declined" && page !== 'declined') {
        window.location.pathname = getPage('declined');
      } else {
        cb(res.data);
      }
    });
  },

  getState: function (cb) {
    if (this.isStateLoaded) {
      cb(this.data);
    } else {
      this.loadState(cb)
    }
  },

  getOrderPage: function () { return getPage('order') },
  getConfirmPage: function () { return getPage('confirmation') },
  getDeclinedPage: function () { return getPage('declined') },
  getCurrentPath: getCurrentPath,
  getUrlParam: urlParam,

  sendOrder: function (formData, cb) {
    var url = "/ajax/order";
    var uid = urlParam("uid");

    if (uid) {
      url = "/ajax/order" + "?uid=" + uid;
    }

    $.post(url, formData, function (res) {
      cb(res);
    });
  },

  getValidationRules: function (name) {
    if (rules[name]) {
      return rules[name];
    }

    return null;
  },

  setUsingBilling: function (flag) {
    this.usingBilling = flag;
  },

  getUsingBilling: function () {
    return this.usingBilling;
  },

  setValidationRule: function (name, rule) {
    this.rules[name] = rule;
  },

  getSelectors: function() {
    return selectors;
  }
};