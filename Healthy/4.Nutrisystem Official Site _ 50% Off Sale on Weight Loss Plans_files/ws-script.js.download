/*Creating this new function to fix ios devices session storage. */
var isOnIOS = navigator.userAgent.match(/iPad/i)|| navigator.userAgent.match(/iPhone/i);
if(isOnIOS !== null) {
	window.addEventListener("pagehide", function (event) {
	    updateSessionStorage();
	});
}
window.onbeforeunload = function(Event) {
	updateSessionStorage();
};
jQuery(document).ready(function() {
	var tempArray;
	var data;
	var formId;
	var elementName;
	var inputType;
	var inputValue = '';
	var isChecked = true;
	var ssCount = sessionStorage.length;
	var ssDataKey = 0;
	var notFoundCount = 0;
	var removeList = [];
	for(var i = 0; i < ssCount; i++) {
		var containsNutriVar = false;
		data = sessionStorage.key(i);		
		
		tempArray = data.split(':', 2);
		formId = tempArray[0];
		elementName = tempArray[1];
		inputValue = sessionStorage.getItem(data);
		if(formId){
			inputType = jQuery('#'+formId+' input[id='+elementName+']').attr('type');
		}		
		
		if (formId.toLowerCase().indexOf("fsr_") >= 0){
			containsNutriVar = true;
			ssDataKey++;
		}
		
		if(formId==null || formId == "" || elementName==null || elementName == "" || containsNutriVar){			
			continue;
		}
		
		if(inputType==null && formId){
			//console.log('try populate in html SELECT field '+elementName+' with value '+inputValue);
			if(elementName == 'State' && jQuery('#'+formId+' select[id='+elementName+']').val() != null && jQuery('#'+formId+' select[id='+elementName+']').val() != ""  && inputValue != null) {
				// skip storing session storage
			} else {
				jQuery('#'+formId+' select[id='+elementName+']').val(inputValue);
			}
			removeList.push(data);			
			continue;
		}
		
		if((inputType=='checkbox' || inputType=='radio') && formId){
			//console.log('try populate in html RADIO field '+elementName+' with value '+inputValue);
			jQuery('#'+formId+' input[id='+elementName+'][value='+inputValue+']').attr('checked',isChecked);
			removeList.push(data);			
			continue;
		} 
		
		if(formId && (jQuery('#'+formId+' input[id='+elementName+']').val().length==0)){
			//console.log('try populate in html TEXT field '+elementName+' with value '+inputValue);
			/* NS-45696 start */
			if(inputValue.trim() !== '' && elementName === 'Address-1' && formId === 'ShippingForm') {
				jQuery('.open-address-line-2').show();
	        	jQuery('#zipbox').show();
	        	jQuery('#BusinessAddress').closest('.form-group').show();
			}
			/* NS-45696 end */
			jQuery('#'+formId+' input[id='+elementName+']').val(inputValue);
			removeList.push(data);			
			continue;
		}
		
		//if value is present then make sure to remove the entry so that subsequent elements
		//can be considered
		if(formId && (jQuery('#'+formId+' input[id='+elementName+']').val().length > 0)){
			removeList.push(data);			
			continue;
		}
	}
	
	for(var i = 0; i < removeList.length; i++) {
		sessionStorage.removeItem(removeList[i]);
	}	
	
});
function updateSessionStorage () {
	var selectedArray = jQuery('[ssvalue]');
	var valuesToskip = jQuery('#skip-ss-value').html();
	var index = 0;
	var key ='';
	var value='';
	var elementName='';
	var formId='';
	
	jQuery.each(selectedArray, function(index, val){
		elementName = selectedArray.get(index).getAttribute('id');
		formId = selectedArray.get(index).form.id;
		key = formId+':'+elementName;		
		if(typeof(valuesToskip) != "undefined" && valuesToskip.indexOf(key)!=-1){
			return;
		};
		var inputType = selectedArray.get(index).type;
		if(inputType=='checkbox' || inputType=='radio'){
			value = jQuery('#'+formId+' input[id='+elementName+']:checked').val();
		} else {
			value = selectedArray.get(index).value;
		};
		
		if(value!=null && value.length!=0 ){
			//console.log(key+':'+value);
			sessionStorage.setItem(key,value);
		};
	});
}

